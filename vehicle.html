<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vehicle Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>Vehicle Dashboard</h1>
</header>

<main class="container">
  <!-- Vehicle Info Card -->
  <div id="vehicle-info" class="card">
    <!-- Vehicle info will load here -->
  </div>

  <!-- Action Buttons Card -->
  <div class="card actions">
    <button id="addMaintenanceBtn">Add Maintenance</button>
    <button id="historyBtn">View Maintenance History</button>
    <button id="scheduleBtn">Schedule Maintenance</button>
    <button id="homeBtn">Home</button>
  </div>
</main>

<footer>
  &copy; 2026 Woods Garage Page
</footer>

<script src="app.js"></script>
<script>
  const vin = new URLSearchParams(window.location.search).get("vin");

  function normalizeVin(v) {
    return String(v ?? "").trim();
  }

  function parseDateSafe(v) {
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }

  function parseOdoSafe(v) {
    const n = Number(String(v ?? "").replace(/,/g, "").trim());
    return Number.isFinite(n) ? n : null;
  }

  function findLastMaintenanceForVin(records, vin) {
    const target = normalizeVin(vin);
    const rows = (Array.isArray(records) ? records : [])
      .filter(r => normalizeVin(r.vin || r.VIN) === target);

    if (!rows.length) return null;

    // Prefer latest valid timestamp
    let latest = null;
    for (const r of rows) {
      const dt = parseDateSafe(r.timestamp);
      if (!dt) continue;
      if (!latest || dt > latest.dt) latest = { r, dt };
    }

    // Fallback: last row if timestamps are missing/unusable
    return latest ? latest.r : rows[rows.length - 1];
  }

  // Load vehicle info + last mileage
  async function loadVehicle() {
    if (!vin) {
      document.getElementById("vehicle-info").innerHTML =
        "<p>Vehicle VIN not found.</p>";
      return;
    }

    try {
      const [vehiclesResp, maintResp] = await Promise.all([
        fetch(`${API_URL}?sheet=Vehicles`),
        fetch(`${API_URL}?sheet=Maintenance`)
      ]);

      if (!vehiclesResp.ok || !maintResp.ok) {
        throw new Error("Failed to fetch data");
      }

      const vehicles = await vehiclesResp.json();
      const maintenance = await maintResp.json();

      const v = (Array.isArray(vehicles) ? vehicles : [])
        .find(r => normalizeVin(r.vin || r.VIN) === normalizeVin(vin));

      const container = document.getElementById("vehicle-info");

      if (!v) {
        container.innerHTML = "<p>Vehicle not found.</p>";
        return;
      }

      const lastMaint = findLastMaintenanceForVin(maintenance, vin);
      const lastOdo = lastMaint ? parseOdoSafe(lastMaint.odometer) : null;
      const lastMileageText = lastOdo !== null
        ? lastOdo.toLocaleString()
        : "â€”";

      container.innerHTML = `
        <h2>${v.name} (${v.year})</h2>
        <p><strong>Make:</strong> ${v.make}</p>
        <p><strong>Model:</strong> ${v.model}</p>
        <p><strong>VIN:</strong> ${normalizeVin(v.vin)}</p>
        <p><strong>Last Mileage:</strong> ${lastMileageText}</p>
      `;
    } catch (err) {
      console.error("Error loading vehicle dashboard:", err);
      document.getElementById("vehicle-info").innerHTML =
        "<p>Unable to load vehicle info.</p>";
    }
  }

  // Button actions
  document.getElementById("addMaintenanceBtn").addEventListener("click", () => {
    window.location.href = `maintenance.html?vin=${encodeURIComponent(vin)}`;
  });

  document.getElementById("historyBtn").addEventListener("click", () => {
    window.location.href = `history.html?vin=${encodeURIComponent(vin)}`;
  });

  document.getElementById("scheduleBtn").addEventListener("click", () => {
    window.location.href = `schedule.html?vin=${encodeURIComponent(vin)}`;
  });

  // Load on page load
  loadVehicle();
</script>

</body>
</html>
