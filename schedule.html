<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Schedule Maintenance</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>Schedule Maintenance</h1>
</header>

<main class="container">
  <form id="scheduleForm" class="card">
    <label for="service">Service</label>
    <input type="text" id="service" required>

    <label for="plannedDate">Planned Date</label>
    <input type="date" id="plannedDate" required>

    <label for="assignedEmail">Send Reminder To</label>
    <select id="assignedEmail" required>
      <option value="">Loading contacts...</option>
    </select>

    <fieldset>
      <legend>Notification Intervals (days before planned date)</legend>
      <label><input type="checkbox" value="14">14</label>
      <label><input type="checkbox" value="7">7</label>
      <label><input type="checkbox" value="3">3</label>
      <label><input type="checkbox" value="1">1</label>
    </fieldset>

    <button type="submit">Schedule Maintenance</button>
  </form>
</main>

<footer>
  &copy; 2026 Woods Garage Maintenance
</footer>

<script src="app.js"></script>
<script>
const vin = new URLSearchParams(window.location.search).get("vin");

// Populate email dropdown from Contacts sheet
async function loadEmails() {
  try {
    const response = await fetch(`${API_URL}?sheet=Contacts`);
    const contacts = await response.json();
    const select = document.getElementById("assignedEmail");
    select.innerHTML = '<option value="">Select email...</option>';

    contacts.forEach(c => {
      const email = (c.email || "").trim();
      const name = (c.name || "").trim();
      if (email) {
        const option = document.createElement("option");
        option.value = email;
        option.textContent = name ? `${name} (${email})` : email;
        select.appendChild(option);
      }
    });
  } catch (err) {
    console.error("Error loading contacts:", err);
    document.getElementById("assignedEmail").innerHTML =
      '<option value="">Unable to load contacts</option>';
  }
}

// Handle form submission
document.addEventListener("DOMContentLoaded", () => {
  loadEmails();

  document.getElementById("scheduleForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const service = document.getElementById("service").value;
    const plannedDate = document.getElementById("plannedDate").value;
    const assignedEmail = document.getElementById("assignedEmail").value;

    // Get selected notification intervals
    const checkboxes = document.querySelectorAll("fieldset input[type=checkbox]:checked");
    const intervals = Array.from(checkboxes).map(cb => parseInt(cb.value));

    if (!service || !plannedDate || !assignedEmail || intervals.length === 0) {
      alert("Please fill all fields and select at least one notification interval.");
      return;
    }

    try {
      const response = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          vin,
          service,
          plannedDate,
          assignedEmail,
          intervals
        }),
      });

      const result = await response.json();

      if (result.status === "success") {
        alert("Maintenance scheduled successfully!");
        window.location.href = `vehicle.html?vin=${vin}`;
      } else {
        alert("Failed to schedule maintenance.");
      }
    } catch (err) {
      console.error("Error scheduling maintenance:", err);
      alert("Error scheduling maintenance.");
    }
  });
});
</script>
</body>
</html>
