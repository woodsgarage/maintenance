<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Schedule Maintenance</title>
  <link rel="stylesheet" href="style.css">
  <script src="app.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const vin = getQueryParam("vin");
      if (!vin) {
        alert("VIN missing in URL");
        return;
      }
      document.getElementById("vehicleVIN").textContent = vin;

      // Load emails into dropdown
      await loadEmails();

      // Handle form submission
      document.getElementById("scheduleForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const plannedDate = document.getElementById("plannedDate").value;
        const service = document.getElementById("service").value;
        const notes = document.getElementById("notes").value;
        const email = document.getElementById("emailSelect").value;

        if (!plannedDate || !service || !email) {
          alert("Please fill in all required fields.");
          return;
        }

        try {
          const data = {
            type: "future",
            vin,
            planned_date: plannedDate,
            service,
            notes,
            email
          };

          const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(data)
          });

          const result = await response.json();
          if (result.status === "success") {
            alert("Maintenance scheduled successfully!");
            document.getElementById("scheduleForm").reset();
          } else {
            alert("Error scheduling maintenance.");
          }
        } catch (err) {
          console.error(err);
          alert("Failed to schedule maintenance.");
        }
      });
    });

    // Load emails into dropdown from Contacts sheet
    async function loadEmails() {
      try {
        const response = await fetch(`${API_URL}?emails=true`);
        const contacts = await response.json();
        const select = document.getElementById("emailSelect");

        contacts.forEach(c => {
          const option = document.createElement("option");
          option.value = c.email;
          option.textContent = `${c.name} (${c.email})`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error("Error loading emails:", err);
      }
    }
  </script>
</head>
<body>
  <header>Schedule Maintenance</header>
  <main>
    <h2>Vehicle VIN: <span id="vehicleVIN">Loading...</span></h2>

    <form id="scheduleForm">
      <label for="plannedDate">Planned Date:</label>
      <input type="date" id="plannedDate" required>

      <label for="service">Service:</label>
      <input type="text" id="service" placeholder="Oil Change, etc." required>

      <label for="notes">Notes:</label>
      <textarea id="notes" placeholder="Optional notes"></textarea>

      <label for="emailSelect">Send Reminder To:</label>
      <select id="emailSelect" required>
        <option value="">Select Email</option>
      </select>

      <button type="submit">Schedule Maintenance</button>
    </form>
  </main>
  <footer>&copy; 2026 Woods Garage</footer>
</body>
</html>
