<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Maintenance</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <h1>Add Maintenance</h1>
</header>

<main class="container">

  <div class="card" id="pageHeaderCard">
    <h2 style="margin:0;">Maintenance Entry</h2>
    <p style="margin:0.5rem 0 0 0; color:#555;">
      VIN: <strong id="vinText">—</strong>
    </p>
  </div>

  <div class="card">
    <form id="maintenanceForm">

      <label for="odometer">Odometer</label>
      <!-- inputmode/pattern helps mobile show numeric keypad -->
      <input
        type="number"
        id="odometer"
        inputmode="numeric"
        pattern="[0-9]*"
        placeholder="e.g., 65100"
        required
      />

      <label for="service">Service</label>
      <input
        type="text"
        id="service"
        placeholder="e.g., Oil change, Tire rotation"
        required
      />

      <label for="parts">Parts</label>
      <input
        type="text"
        id="parts"
        placeholder="e.g., Filter, 15W-40, Brake pads"
      />

      <label for="notes">Notes</label>
      <textarea
        id="notes"
        rows="4"
        placeholder="Optional notes…"
      ></textarea>

      <!-- Two submit modes -->
      <div style="display:flex; gap:0.75rem; flex-wrap:wrap; margin-top:1rem;">
        <button type="button" id="btnSaveReturn">Save &amp; Return</button>
        <button type="button" id="btnSaveAddAnother">Save &amp; Add Another</button>
      </div>

      <p id="statusText" style="margin-top:0.75rem; color:#555;"></p>
    </form>
  </div>

</main>

<footer>
  &copy; 2026 Woods Garage Maintenance
</footer>

<script src="app.js"></script>
<script>
  const vin = qs("vin");
  const vinTextEl = document.getElementById("vinText");
  const statusText = document.getElementById("statusText");

  const odometerEl = document.getElementById("odometer");
  const serviceEl = document.getElementById("service");
  const partsEl = document.getElementById("parts");
  const notesEl = document.getElementById("notes");

  const btnSaveReturn = document.getElementById("btnSaveReturn");
  const btnSaveAddAnother = document.getElementById("btnSaveAddAnother");

  function setBusy(isBusy, message) {
    btnSaveReturn.disabled = isBusy;
    btnSaveAddAnother.disabled = isBusy;
    statusText.textContent = message || "";
  }

  function toNumberOrNull(v) {
    const n = Number(String(v ?? "").toString().trim());
    return Number.isFinite(n) ? n : null;
  }

  function getVinFromRecord(r) {
    return (r && (r.vin ?? r.VIN)) != null ? String(r.vin ?? r.VIN).trim() : "";
  }

  function getOdometerFromRecord(r) {
    // tolerate different column casing
    return toNumberOrNull(r?.odometer ?? r?.Odometer ?? r?.mileage ?? r?.Mileage);
  }

  function getTimestampFromRecord(r) {
    return r?.timestamp ?? r?.Timestamp ?? r?.date ?? r?.Date ?? "";
  }

  function pickLatestRecord(recordsForVin) {
    // Sort by timestamp descending when possible, otherwise fall back to last row order
    const withDate = recordsForVin
      .map(r => ({ r, d: new Date(getTimestampFromRecord(r)) }))
      .filter(x => x.d.toString() !== "Invalid Date");

    if (withDate.length > 0) {
      withDate.sort((a, b) => b.d - a.d);
      return withDate[0].r;
    }

    // no valid dates; last entry as best-effort
    return recordsForVin.length ? recordsForVin[recordsForVin.length - 1] : null;
  }

  async function fetchLastMaintenanceOdometer(forVin) {
    const all = await getMaintenance(); // JSONP GET from app.js
    if (!Array.isArray(all)) return null;

    const filtered = all.filter(r => getVinFromRecord(r) === String(forVin).trim());
    const latest = pickLatestRecord(filtered);
    return latest ? getOdometerFromRecord(latest) : null;
  }

  async function prefillOdometerOnLoad() {
    setBusy(true, "Loading last odometer…");
    try {
      const lastOdo = await fetchLastMaintenanceOdometer(vin);
      if (lastOdo != null) {
        odometerEl.value = String(lastOdo + 100); // ON LOAD: +100
        statusText.textContent = `Prefilled odometer: last (${lastOdo}) + 100`;
      } else {
        statusText.textContent = "No prior maintenance found; enter odometer manually.";
      }
    } catch (e) {
      console.error(e);
      statusText.textContent = "Could not prefill odometer (check console).";
    } finally {
      setBusy(false);
    }
  }

  async function prefillOdometerAfterSaveAddAnother() {
    setBusy(true, "Refreshing odometer…");
    try {
      const lastOdo = await fetchLastMaintenanceOdometer(vin);
      if (lastOdo != null) {
        odometerEl.value = String(lastOdo); // AFTER SAVE & ADD ANOTHER: EXACT (no +100)
        statusText.textContent = `Ready for next entry. Odometer set to latest: ${lastOdo}`;
      } else {
        odometerEl.value = "";
        statusText.textContent = "No prior maintenance found; enter odometer manually.";
      }
    } catch (e) {
      console.error(e);
      statusText.textContent = "Could not refresh odometer (check console).";
    } finally {
      setBusy(false);
      odometerEl.focus();
      odometerEl.select();
    }
  }

  function validate() {
    if (!vin) {
      alert("Missing VIN in the URL. Open this page from the Vehicle Dashboard.");
      return false;
    }
    if (!odometerEl.value.trim() || !serviceEl.value.trim()) {
      alert("Please enter at least Odometer and Service.");
      return false;
    }
    return true;
  }

  async function saveMaintenance() {
    const payload = {
      vin: String(vin).trim(),
      odometer: odometerEl.value.trim(),
      service: serviceEl.value.trim(),
      parts: partsEl.value.trim(),
      notes: notesEl.value.trim()
    };

    setBusy(true, "Saving maintenance…");
    try {
      const result = await postMaintenance(payload); // POST from app.js
      if (result && result.status === "success") {
        return { ok: true };
      }
      return { ok: false, message: result?.message || "Unknown error from server" };
    } catch (e) {
      console.error(e);
      return { ok: false, message: "Failed to save (network/API error). See console." };
    } finally {
      setBusy(false);
    }
  }

  function clearEntryFields() {
    serviceEl.value = "";
    partsEl.value = "";
    notesEl.value = "";
  }

  // Button: Save & Return
  btnSaveReturn.addEventListener("click", async () => {
    if (!validate()) return;

    const { ok, message } = await saveMaintenance();
    if (!ok) {
      alert("Save failed: " + message);
      return;
    }

    alert("Maintenance saved!");
    window.location.href = `vehicle.html?vin=${encodeURIComponent(vin)}`;
  });

  // Button: Save & Add Another
  btnSaveAddAnother.addEventListener("click", async () => {
    if (!validate()) return;

    const { ok, message } = await saveMaintenance();
    if (!ok) {
      alert("Save failed: " + message);
      return;
    }

    alert("Maintenance saved! Ready for another entry.");
    clearEntryFields();
    await prefillOdometerAfterSaveAddAnother();
  });

  // Init
  document.addEventListener("DOMContentLoaded", async () => {
    vinTextEl.textContent = vin ? vin : "Missing VIN";
    if (!vin) {
      setBusy(true, "Missing VIN. Open this page from the Vehicle Dashboard.");
      return;
    }
    await prefillOdometerOnLoad();
  });
</script>

</body>
</html>
